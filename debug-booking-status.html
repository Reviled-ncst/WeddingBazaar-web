<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Backend Status Update Debug</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 900px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background: #d4edda; border-color: #c3e6cb; }
        .error { background: #f8d7da; border-color: #f5c6cb; }
        .info { background: #d1ecf1; border-color: #bee5eb; }
        button { margin: 5px; padding: 8px 15px; border: none; border-radius: 3px; cursor: pointer; background: #007bff; color: white; }
        button:hover { background: #0056b3; }
        pre { background: #f8f9fa; padding: 15px; border-radius: 5px; overflow-x: auto; font-size: 12px; }
        .status-check { margin: 10px 0; padding: 10px; border-left: 4px solid #007bff; background: #f8f9fa; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Backend Status Update Debug</h1>
        <p>Debugging why booking status shows as updated but UI still shows "request"</p>

        <div class="test-section info">
            <h3>üìã Test Setup</h3>
            <p><strong>Backend URL:</strong> <span id="backendUrl">https://weddingbazaar-web.onrender.com</span></p>
            <p><strong>Test Booking ID:</strong> <span id="testBookingId">662340</span></p>
            <p><strong>Auth Token:</strong> <span id="authStatus">Checking...</span></p>
        </div>

        <div class="test-section">
            <h3>üß™ Debug Tests</h3>
            <button onclick="getCurrentBookingStatus()">1. Get Current Booking Status</button>
            <button onclick="updateToQuoteSent()">2. Update to quote_sent</button>
            <button onclick="verifyStatusAfterUpdate()">3. Verify Status After Update</button>
            <button onclick="getAllVendorBookings()">4. Get All Vendor Bookings</button>
        </div>

        <div class="test-section">
            <h3>üìä Debug Results</h3>
            <div id="debugResults"></div>
        </div>
    </div>

    <script>
        const BACKEND_URL = 'https://weddingbazaar-web.onrender.com';
        const TEST_BOOKING_ID = '662340';
        const VENDOR_ID = '2-2025-003';
        
        // Check auth token
        const authToken = localStorage.getItem('auth_token');
        document.getElementById('authStatus').textContent = authToken ? '‚úÖ Found' : '‚ùå Missing';
        
        function getAuthHeaders() {
            const token = localStorage.getItem('auth_token');
            return {
                'Content-Type': 'application/json',
                'Authorization': token ? `Bearer ${token}` : ''
            };
        }
        
        function addResult(title, data, isError = false) {
            const resultsDiv = document.getElementById('debugResults');
            const resultDiv = document.createElement('div');
            resultDiv.className = `status-check ${isError ? 'error' : 'success'}`;
            
            resultDiv.innerHTML = `
                <h4>${isError ? '‚ùå' : '‚úÖ'} ${title}</h4>
                <pre>${typeof data === 'string' ? data : JSON.stringify(data, null, 2)}</pre>
            `;
            resultsDiv.insertBefore(resultDiv, resultsDiv.firstChild);
        }
        
        async function getCurrentBookingStatus() {
            console.log('üîç Getting current booking status...');
            
            try {
                // Try to get the specific booking
                const response = await fetch(`${BACKEND_URL}/api/bookings/${TEST_BOOKING_ID}`, {
                    method: 'GET',
                    headers: getAuthHeaders()
                });
                
                if (response.ok) {
                    const booking = await response.json();
                    console.log('üìä Current booking data:', booking);
                    addResult('Current Booking Status', {
                        id: booking.id,
                        status: booking.status,
                        vendor_notes: booking.vendor_notes,
                        updated_at: booking.updated_at,
                        quote_sent_date: booking.quote_sent_date
                    });
                } else {
                    const errorText = await response.text();
                    console.error('‚ùå Failed to get booking:', response.status, errorText);
                    addResult('Get Booking Failed', `${response.status}: ${errorText}`, true);
                }
            } catch (error) {
                console.error('üí• Error getting booking:', error);
                addResult('Get Booking Error', error.message, true);
            }
        }
        
        async function updateToQuoteSent() {
            console.log('üîÑ Updating booking to quote_sent...');
            
            const testQuoteData = {
                status: 'quote_sent',
                message: 'DEBUG TEST: Quote sent with 3 items totaling ‚Ç±15,000'
            };
            
            try {
                const response = await fetch(`${BACKEND_URL}/api/bookings/${TEST_BOOKING_ID}/status`, {
                    method: 'PUT',
                    headers: getAuthHeaders(),
                    body: JSON.stringify(testQuoteData)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('‚úÖ Status update successful:', result);
                    addResult('Status Update Success', {
                        request: testQuoteData,
                        response: result,
                        newStatus: result.status,
                        timestamp: result.updated_at
                    });
                } else {
                    const errorText = await response.text();
                    console.error('‚ùå Status update failed:', response.status, errorText);
                    addResult('Status Update Failed', `${response.status}: ${errorText}`, true);
                }
            } catch (error) {
                console.error('üí• Status update error:', error);
                addResult('Status Update Error', error.message, true);
            }
        }
        
        async function verifyStatusAfterUpdate() {
            console.log('üîç Verifying status after update...');
            
            // Wait a moment for backend to process
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await getCurrentBookingStatus();
        }
        
        async function getAllVendorBookings() {
            console.log('üìã Getting all vendor bookings...');
            
            try {
                const response = await fetch(`${BACKEND_URL}/api/bookings/vendor/${VENDOR_ID}`, {
                    method: 'GET',
                    headers: getAuthHeaders()
                });
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('üìä All vendor bookings:', data);
                    
                    // Find our test booking
                    const testBooking = data.bookings?.find(b => b.id.toString() === TEST_BOOKING_ID);
                    
                    addResult('All Vendor Bookings', {
                        totalBookings: data.count || data.bookings?.length || 0,
                        testBookingFound: !!testBooking,
                        testBookingStatus: testBooking?.status || 'NOT FOUND',
                        allBookings: data.bookings?.map(b => ({
                            id: b.id,
                            status: b.status,
                            service_type: b.service_type
                        })) || []
                    });
                } else {
                    const errorText = await response.text();
                    console.error('‚ùå Failed to get vendor bookings:', response.status, errorText);
                    addResult('Get Vendor Bookings Failed', `${response.status}: ${errorText}`, true);
                }
            } catch (error) {
                console.error('üí• Error getting vendor bookings:', error);
                addResult('Get Vendor Bookings Error', error.message, true);
            }
        }
        
        // Auto-run initial status check
        setTimeout(() => {
            getCurrentBookingStatus();
        }, 1000);
    </script>
</body>
</html>
