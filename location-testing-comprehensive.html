<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wedding Bazaar - Location Testing</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }
        
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .test-section {
            margin: 30px 0;
            padding: 20px;
            border: 2px solid #e0e0e0;
            border-radius: 15px;
            background: rgba(255, 255, 255, 0.8);
        }
        
        .location-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .location-card {
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 10px;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .location-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border-color: #667eea;
        }
        
        .location-card.selected {
            border-color: #667eea;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }
        
        .location-name {
            font-weight: bold;
            font-size: 1.1em;
            margin-bottom: 5px;
        }
        
        .location-coords {
            font-size: 0.9em;
            opacity: 0.7;
        }
        
        .controls {
            display: flex;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        
        button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .results {
            margin: 20px 0;
            padding: 15px;
            border-radius: 10px;
            background: #f8f9fa;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .log-entry {
            padding: 8px 12px;
            margin: 5px 0;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }
        
        .log-success { background: #d4edda; color: #155724; }
        .log-error { background: #f8d7da; color: #721c24; }
        .log-info { background: #d1ecf1; color: #0c5460; }
        .log-warning { background: #fff3cd; color: #856404; }
        
        .status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
            margin-left: 10px;
        }
        
        .status.success { background: #28a745; color: white; }
        .status.error { background: #dc3545; color: white; }
        .status.pending { background: #ffc107; color: black; }
        
        .summary {
            margin: 20px 0;
            padding: 20px;
            border-radius: 15px;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
            border: 2px solid rgba(102, 126, 234, 0.2);
        }
        
        .metric {
            display: inline-block;
            margin: 10px 15px;
            text-align: center;
        }
        
        .metric-value {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }
        
        .metric-label {
            font-size: 0.9em;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üåç Wedding Bazaar Location Testing</h1>
        
        <div class="test-section">
            <h2>üìç Select Test Locations</h2>
            <p>Choose locations to test booking functionality. You can select multiple locations.</p>
            
            <div class="location-grid" id="locationGrid">
                <!-- Locations will be populated by JavaScript -->
            </div>
            
            <div class="controls">
                <button onclick="selectAllPhilippines()">Select All Philippines</button>
                <button onclick="selectAllInternational()">Select International</button>
                <button onclick="selectAll()">Select All</button>
                <button onclick="clearSelection()">Clear All</button>
            </div>
        </div>
        
        <div class="test-section">
            <h2>üöÄ Test Controls</h2>
            <div class="controls">
                <button onclick="startTest()" id="startBtn">Start Location Test</button>
                <button onclick="checkExistingBookings()" id="checkBtn">Check Existing Bookings</button>
                <button onclick="clearResults()">Clear Results</button>
            </div>
            
            <div class="summary" id="summary" style="display: none;">
                <h3>üìä Test Summary</h3>
                <div id="summaryContent"></div>
            </div>
        </div>
        
        <div class="test-section">
            <h2>üìã Test Results</h2>
            <div class="results" id="results">
                <div class="log-info">Ready to start testing. Select locations and click "Start Location Test".</div>
            </div>
        </div>
    </div>

    <script>
        // Test locations with categories
        const testLocations = [
            // Philippines - Major Cities
            { name: "Manila, Philippines", lat: 14.5995, lng: 120.9842, category: "philippines" },
            { name: "Cebu City, Philippines", lat: 10.3157, lng: 123.8854, category: "philippines" },
            { name: "Davao City, Philippines", lat: 7.1907, lng: 125.4553, category: "philippines" },
            { name: "Quezon City, Philippines", lat: 14.6760, lng: 121.0437, category: "philippines" },
            { name: "Makati, Philippines", lat: 14.5547, lng: 121.0244, category: "philippines" },
            { name: "Iloilo City, Philippines", lat: 10.7202, lng: 122.5621, category: "philippines" },
            { name: "Baguio, Philippines", lat: 16.4023, lng: 120.5960, category: "philippines" },
            { name: "Cagayan de Oro, Philippines", lat: 8.4542, lng: 124.6319, category: "philippines" },
            
            // Philippines - Tourist Destinations
            { name: "Boracay, Philippines", lat: 11.9674, lng: 121.9248, category: "philippines" },
            { name: "Palawan, Philippines", lat: 9.8349, lng: 118.7384, category: "philippines" },
            { name: "Bohol, Philippines", lat: 9.8349, lng: 124.1436, category: "philippines" },
            { name: "Siargao, Philippines", lat: 9.8592, lng: 126.0570, category: "philippines" },
            
            // International - Asia
            { name: "Tokyo, Japan", lat: 35.6762, lng: 139.6503, category: "international" },
            { name: "Seoul, South Korea", lat: 37.5665, lng: 126.9780, category: "international" },
            { name: "Bangkok, Thailand", lat: 13.7563, lng: 100.5018, category: "international" },
            { name: "Singapore", lat: 1.3521, lng: 103.8198, category: "international" },
            { name: "Hong Kong", lat: 22.3193, lng: 114.1694, category: "international" },
            
            // International - Europe
            { name: "Paris, France", lat: 48.8566, lng: 2.3522, category: "international" },
            { name: "London, UK", lat: 51.5074, lng: -0.1278, category: "international" },
            { name: "Rome, Italy", lat: 41.9028, lng: 12.4964, category: "international" },
            { name: "Barcelona, Spain", lat: 41.3851, lng: 2.1734, category: "international" },
            
            // International - Americas
            { name: "New York, USA", lat: 40.7128, lng: -74.0060, category: "international" },
            { name: "Los Angeles, USA", lat: 34.0522, lng: -118.2437, category: "international" },
            { name: "Toronto, Canada", lat: 43.6532, lng: -79.3832, category: "international" },
            { name: "Mexico City, Mexico", lat: 19.4326, lng: -99.1332, category: "international" },
            
            // International - Oceania
            { name: "Sydney, Australia", lat: -33.8688, lng: 151.2093, category: "international" },
            { name: "Auckland, New Zealand", lat: -36.8485, lng: 174.7633, category: "international" }
        ];

        const API_BASE = 'https://weddingbazaar-web.onrender.com/api';
        let selectedLocations = [];
        let authToken = null;

        // Initialize the location grid
        function initializeLocationGrid() {
            const grid = document.getElementById('locationGrid');
            grid.innerHTML = '';
            
            testLocations.forEach((location, index) => {
                const card = document.createElement('div');
                card.className = 'location-card';
                card.dataset.index = index;
                card.innerHTML = `
                    <div class="location-name">${location.name}</div>
                    <div class="location-coords">${location.lat.toFixed(4)}, ${location.lng.toFixed(4)}</div>
                `;
                
                card.addEventListener('click', () => toggleLocation(index));
                grid.appendChild(card);
            });
        }

        function toggleLocation(index) {
            const card = document.querySelector(`[data-index="${index}"]`);
            const location = testLocations[index];
            
            if (selectedLocations.includes(index)) {
                // Remove from selection
                selectedLocations = selectedLocations.filter(i => i !== index);
                card.classList.remove('selected');
            } else {
                // Add to selection
                selectedLocations.push(index);
                card.classList.add('selected');
            }
            
            logMessage(`${selectedLocations.includes(index) ? 'Selected' : 'Deselected'}: ${location.name}`, 'info');
        }

        function selectAllPhilippines() {
            clearSelection();
            testLocations.forEach((location, index) => {
                if (location.category === 'philippines') {
                    selectedLocations.push(index);
                    document.querySelector(`[data-index="${index}"]`).classList.add('selected');
                }
            });
            logMessage(`Selected ${selectedLocations.length} Philippines locations`, 'info');
        }

        function selectAllInternational() {
            clearSelection();
            testLocations.forEach((location, index) => {
                if (location.category === 'international') {
                    selectedLocations.push(index);
                    document.querySelector(`[data-index="${index}"]`).classList.add('selected');
                }
            });
            logMessage(`Selected ${selectedLocations.length} international locations`, 'info');
        }

        function selectAll() {
            clearSelection();
            testLocations.forEach((location, index) => {
                selectedLocations.push(index);
                document.querySelector(`[data-index="${index}"]`).classList.add('selected');
            });
            logMessage(`Selected all ${selectedLocations.length} locations`, 'info');
        }

        function clearSelection() {
            selectedLocations = [];
            document.querySelectorAll('.location-card').forEach(card => {
                card.classList.remove('selected');
            });
        }

        function logMessage(message, type = 'info') {
            const results = document.getElementById('results');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.innerHTML = `${new Date().toLocaleTimeString()} - ${message}`;
            results.appendChild(entry);
            results.scrollTop = results.scrollHeight;
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '<div class="log-info">Results cleared. Ready for new test.</div>';
            document.getElementById('summary').style.display = 'none';
        }

        async function login() {
            if (authToken) return authToken;
            
            logMessage('üîê Attempting to login...', 'info');
            
            try {
                const response = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: 'test@example.com',
                        password: 'password123'
                    })
                });

                const data = await response.json();
                if (data.success && data.token) {
                    authToken = data.token;
                    logMessage('‚úÖ Login successful', 'success');
                    return authToken;
                } else {
                    logMessage(`‚ùå Login failed: ${data.message}`, 'error');
                    return null;
                }
            } catch (error) {
                logMessage(`‚ùå Login error: ${error.message}`, 'error');
                return null;
            }
        }

        async function createBookingWithLocation(location) {
            const bookingData = {
                vendor_id: '1',
                service_type: 'Wedding Photography',
                event_date: '2024-12-20',
                event_location: location.name,
                event_time: '15:00',
                guest_count: 150,
                message: `Test booking for ${location.name} - Created at ${new Date().toLocaleTimeString()}`,
                contact_phone: '+63123456789'
            };

            try {
                const response = await fetch(`${API_BASE}/bookings`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(bookingData)
                });

                const result = await response.json();
                
                if (result.success) {
                    logMessage(`‚úÖ Booking created for ${location.name} (ID: ${result.booking.id})`, 'success');
                    return result.booking;
                } else {
                    logMessage(`‚ùå Booking failed for ${location.name}: ${result.message}`, 'error');
                    return null;
                }
            } catch (error) {
                logMessage(`‚ùå Booking error for ${location.name}: ${error.message}`, 'error');
                return null;
            }
        }

        async function getBookings() {
            try {
                const response = await fetch(`${API_BASE}/bookings`, {
                    method: 'GET',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                const result = await response.json();
                
                if (result.success) {
                    return result.bookings;
                } else {
                    logMessage(`‚ùå Failed to get bookings: ${result.message}`, 'error');
                    return [];
                }
            } catch (error) {
                logMessage(`‚ùå Get bookings error: ${error.message}`, 'error');
                return [];
            }
        }

        async function startTest() {
            if (selectedLocations.length === 0) {
                logMessage('‚ö†Ô∏è Please select at least one location to test', 'warning');
                return;
            }

            const startBtn = document.getElementById('startBtn');
            startBtn.disabled = true;
            startBtn.textContent = 'Testing...';

            logMessage(`üöÄ Starting location test with ${selectedLocations.length} locations`, 'info');

            // Login first
            const token = await login();
            if (!token) {
                logMessage('‚ùå Cannot proceed without authentication', 'error');
                startBtn.disabled = false;
                startBtn.textContent = 'Start Location Test';
                return;
            }

            const testResults = {
                total: selectedLocations.length,
                success: 0,
                failed: 0,
                locations: {}
            };

            // Create bookings for selected locations
            for (const index of selectedLocations) {
                const location = testLocations[index];
                logMessage(`üìç Testing: ${location.name}`, 'info');
                
                const booking = await createBookingWithLocation(location);
                if (booking) {
                    testResults.success++;
                    testResults.locations[location.name] = 'success';
                } else {
                    testResults.failed++;
                    testResults.locations[location.name] = 'failed';
                }
                
                // Small delay between requests
                await new Promise(resolve => setTimeout(resolve, 1000));
            }

            // Get all bookings to verify
            logMessage('üîç Retrieving all bookings to verify location storage...', 'info');
            const allBookings = await getBookings();

            // Analyze results
            const locationCounts = {};
            allBookings.forEach(booking => {
                const loc = booking.eventLocation || 'Unknown';
                locationCounts[loc] = (locationCounts[loc] || 0) + 1;
            });

            logMessage('üìä Location Analysis:', 'info');
            Object.entries(locationCounts).forEach(([location, count]) => {
                const isDefault = location === 'Los Angeles, CA';
                const type = isDefault ? 'warning' : 'success';
                const emoji = isDefault ? '‚ö†Ô∏è' : '‚úÖ';
                logMessage(`${emoji} ${location}: ${count} booking(s)`, type);
            });

            // Show summary
            const defaultCount = locationCounts['Los Angeles, CA'] || 0;
            const totalCount = allBookings.length;
            const correctCount = totalCount - defaultCount;
            const successRate = totalCount > 0 ? Math.round((correctCount / totalCount) * 100) : 0;

            showSummary({
                total: totalCount,
                correct: correctCount,
                incorrect: defaultCount,
                successRate: successRate,
                testResults: testResults
            });

            startBtn.disabled = false;
            startBtn.textContent = 'Start Location Test';
            
            logMessage(`üéâ Test completed! Success rate: ${successRate}%`, successRate >= 80 ? 'success' : 'warning');
        }

        async function checkExistingBookings() {
            const checkBtn = document.getElementById('checkBtn');
            checkBtn.disabled = true;
            checkBtn.textContent = 'Checking...';

            const token = await login();
            if (!token) {
                checkBtn.disabled = false;
                checkBtn.textContent = 'Check Existing Bookings';
                return;
            }

            logMessage('üîç Checking existing bookings...', 'info');
            const bookings = await getBookings();

            if (bookings.length === 0) {
                logMessage('üìã No existing bookings found', 'info');
            } else {
                logMessage(`üìã Found ${bookings.length} existing bookings:`, 'info');
                bookings.forEach((booking, index) => {
                    const isDefault = booking.eventLocation === 'Los Angeles, CA';
                    const type = isDefault ? 'warning' : 'success';
                    logMessage(`${index + 1}. ${booking.serviceType} at "${booking.eventLocation}" (ID: ${booking.id})`, type);
                });
            }

            checkBtn.disabled = false;
            checkBtn.textContent = 'Check Existing Bookings';
        }

        function showSummary(data) {
            const summary = document.getElementById('summary');
            const content = document.getElementById('summaryContent');
            
            content.innerHTML = `
                <div class="metric">
                    <div class="metric-value">${data.total}</div>
                    <div class="metric-label">Total Bookings</div>
                </div>
                <div class="metric">
                    <div class="metric-value">${data.correct}</div>
                    <div class="metric-label">Correct Locations</div>
                </div>
                <div class="metric">
                    <div class="metric-value">${data.incorrect}</div>
                    <div class="metric-label">Default Locations</div>
                </div>
                <div class="metric">
                    <div class="metric-value">${data.successRate}%</div>
                    <div class="metric-label">Success Rate</div>
                </div>
                <div class="metric">
                    <div class="metric-value">${data.testResults.success}</div>
                    <div class="metric-label">Test Success</div>
                </div>
                <div class="metric">
                    <div class="metric-value">${data.testResults.failed}</div>
                    <div class="metric-label">Test Failed</div>
                </div>
            `;
            
            summary.style.display = 'block';
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            initializeLocationGrid();
            logMessage('üåç Location testing interface ready. Select locations and start testing!', 'info');
        });
    </script>
</body>
</html>
