<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Service Creation Fix Verification</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 1200px; margin: 0 auto; }
        .test-section { margin: 20px 0; padding: 15px; border: 2px solid #ddd; border-radius: 8px; }
        .success { border-color: #28a745; background-color: #d4edda; }
        .error { border-color: #dc3545; background-color: #f8d7da; }
        .info { border-color: #17a2b8; background-color: #d1ecf1; }
        button { padding: 10px 20px; margin: 10px 5px; border: none; border-radius: 5px; cursor: pointer; }
        .btn-primary { background-color: #007bff; color: white; }
        .btn-success { background-color: #28a745; color: white; }
        .btn-danger { background-color: #dc3545; color: white; }
        pre { background-color: #f8f9fa; padding: 10px; border-radius: 5px; overflow-x: auto; }
        .log { font-family: monospace; background-color: #f8f9fa; padding: 5px; margin: 5px 0; border-radius: 3px; }
    </style>
</head>
<body>
    <h1>üîß Service Creation Fix Verification</h1>
    <p><strong>Purpose:</strong> Test the service creation functionality after implementing vendor_id fix and duplicate submission prevention.</p>

    <div id="results"></div>

    <div class="test-section info">
        <h2>üß™ Test Suite</h2>
        <button class="btn-primary" onclick="testServiceCreation()">Test Service Creation</button>
        <button class="btn-primary" onclick="testBackendEndpoint()">Test Backend Endpoint</button>
        <button class="btn-primary" onclick="testDuplicateSubmission()">Test Duplicate Prevention</button>
        <button class="btn-success" onclick="runAllTests()">Run All Tests</button>
        <button class="btn-danger" onclick="clearResults()">Clear Results</button>
    </div>

    <script>
        let testResults = [];
        let testCounter = 0;

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            console.log(logEntry);
            
            const resultsDiv = document.getElementById('results');
            const logDiv = document.createElement('div');
            logDiv.className = `log test-section ${type}`;
            logDiv.innerHTML = `<strong>${logEntry}</strong>`;
            resultsDiv.appendChild(logDiv);
            resultsDiv.scrollTop = resultsDiv.scrollHeight;
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
            testResults = [];
            testCounter = 0;
            log('üßπ Results cleared', 'info');
        }

        async function testBackendEndpoint() {
            log('üîç Testing backend service creation endpoint...', 'info');
            
            const testService = {
                vendor_id: 'vendor_1760361280352',
                vendorId: 'vendor_1760361280352',
                title: 'Test Service Creation - Fix Verification',
                name: 'Test Service Creation - Fix Verification',
                category: 'Photography',
                description: 'This is a test service to verify the vendor_id fix is working properly.',
                price: 2500,
                images: [
                    'https://res.cloudinary.com/dht64xt1g/image/upload/test1.jpg',
                    'https://res.cloudinary.com/dht64xt1g/image/upload/test2.jpg'
                ]
            };

            try {
                log('üì§ Sending service creation request to backend...', 'info');
                log('üìã Service data: ' + JSON.stringify(testService, null, 2), 'info');

                const response = await fetch('https://weddingbazaar-web.onrender.com/api/services', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(testService)
                });

                log(`üìä Response status: ${response.status}`, response.ok ? 'success' : 'error');

                const responseData = await response.json();
                log('üì¶ Response data: ' + JSON.stringify(responseData, null, 2), response.ok ? 'success' : 'error');

                if (response.ok && responseData.success) {
                    log('‚úÖ Backend service creation test PASSED', 'success');
                    log(`üÜî Created service ID: ${responseData.service?.id}`, 'success');
                    log(`üè¢ Vendor ID stored: ${responseData.service?.vendor_id || 'MISSING!'}`, responseData.service?.vendor_id ? 'success' : 'error');
                    
                    // Test cleanup - delete the test service
                    if (responseData.service?.id) {
                        log('üóëÔ∏è Cleaning up test service...', 'info');
                        const deleteResponse = await fetch(`https://weddingbazaar-web.onrender.com/api/services/${responseData.service.id}`, {
                            method: 'DELETE'
                        });
                        log(`üóëÔ∏è Cleanup status: ${deleteResponse.status}`, deleteResponse.ok ? 'success' : 'error');
                    }
                    
                    testResults.push({ test: 'Backend Endpoint', status: 'PASSED', vendorIdStored: !!responseData.service?.vendor_id });
                } else {
                    log('‚ùå Backend service creation test FAILED', 'error');
                    log(`‚ùå Error: ${responseData.error || responseData.message || 'Unknown error'}`, 'error');
                    testResults.push({ test: 'Backend Endpoint', status: 'FAILED', error: responseData.error });
                }

            } catch (error) {
                log(`‚ùå Backend test failed with exception: ${error.message}`, 'error');
                testResults.push({ test: 'Backend Endpoint', status: 'FAILED', error: error.message });
            }
        }

        async function testServiceCreation() {
            log('üöÄ Testing complete service creation workflow...', 'info');
            
            // Simulate the frontend service creation workflow
            const mockFormData = {
                title: 'Wedding Photography Package - Test',
                description: 'Professional wedding photography services with full day coverage, edited photos, and online gallery.',
                category: 'Photographer & Videographer',
                price: '45000',
                images: [
                    'https://res.cloudinary.com/dht64xt1g/image/upload/sample1.jpg',
                    'https://res.cloudinary.com/dht64xt1g/image/upload/sample2.jpg'
                ],
                featured: true,
                is_active: true,
                location: 'Manila, Philippines',
                price_range: '‚Ç±‚Ç±‚Ç±',
                features: [
                    'DSLR Camera with professional lenses',
                    'Professional lighting equipment',
                    '8 hours of wedding coverage',
                    '500+ edited high-resolution photos',
                    'Online gallery with download access'
                ],
                contact_info: {
                    phone: '+63 912 345 6789',
                    email: 'photographer@test.com',
                    website: 'https://testphotographer.com'
                },
                tags: ['wedding', 'photography', 'professional', 'manila'],
                keywords: 'wedding photography manila professional'
            };

            try {
                // Transform data like the frontend does
                const serviceData = {
                    ...mockFormData,
                    price: parseFloat(mockFormData.price),
                    vendor_id: 'vendor_1760361280352', // This should be properly stored now
                    images: mockFormData.images.length > 0 ? mockFormData.images : ['https://images.unsplash.com/photo-1606216794074-735e91aa2c92?w=400']
                };

                log('üì§ Testing frontend-style service creation...', 'info');
                log('üìã Transformed service data: ' + JSON.stringify(serviceData, null, 2), 'info');

                const response = await fetch('https://weddingbazaar-web.onrender.com/api/services', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(serviceData)
                });

                const responseData = await response.json();
                
                if (response.ok && responseData.success) {
                    log('‚úÖ Frontend-style service creation PASSED', 'success');
                    log(`üÜî Service created with ID: ${responseData.service.id}`, 'success');
                    log(`üè¢ Vendor ID properly stored: ${responseData.service.vendor_id}`, 'success');
                    log(`üí∞ Price stored as: ${responseData.service.price} (type: ${typeof responseData.service.price})`, 'success');
                    log(`üéØ Featured status: ${responseData.service.featured}`, 'success');
                    
                    // Cleanup
                    if (responseData.service?.id) {
                        const deleteResponse = await fetch(`https://weddingbazaar-web.onrender.com/api/services/${responseData.service.id}`, {
                            method: 'DELETE'
                        });
                        log(`üóëÔ∏è Test service cleaned up: ${deleteResponse.status}`, deleteResponse.ok ? 'success' : 'info');
                    }
                    
                    testResults.push({ test: 'Frontend Workflow', status: 'PASSED' });
                } else {
                    log('‚ùå Frontend-style service creation FAILED', 'error');
                    log(`‚ùå Error: ${responseData.error || responseData.message}`, 'error');
                    testResults.push({ test: 'Frontend Workflow', status: 'FAILED', error: responseData.error });
                }

            } catch (error) {
                log(`‚ùå Service creation test failed: ${error.message}`, 'error');
                testResults.push({ test: 'Frontend Workflow', status: 'FAILED', error: error.message });
            }
        }

        async function testDuplicateSubmission() {
            log('üîí Testing duplicate submission prevention...', 'info');
            
            const testService = {
                vendor_id: 'vendor_1760361280352',
                title: 'Duplicate Test Service',
                category: 'Photography',
                description: 'Testing duplicate submission prevention',
                price: 1000,
                images: ['https://test.com/image.jpg']
            };

            try {
                log('üì§ Sending first request...', 'info');
                const promise1 = fetch('https://weddingbazaar-web.onrender.com/api/services', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(testService)
                });

                log('üì§ Sending second request immediately...', 'info');
                const promise2 = fetch('https://weddingbazaar-web.onrender.com/api/services', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(testService)
                });

                const [response1, response2] = await Promise.all([promise1, promise2]);
                const [data1, data2] = await Promise.all([response1.json(), response2.json()]);

                log(`üìä First request: ${response1.status} - ${data1.success ? 'SUCCESS' : 'FAILED'}`, response1.ok ? 'success' : 'error');
                log(`üìä Second request: ${response2.status} - ${data2.success ? 'SUCCESS' : 'FAILED'}`, response2.ok ? 'success' : 'error');

                // Both requests should succeed since backend doesn't prevent duplicates (that's frontend responsibility)
                if (response1.ok && response2.ok) {
                    log('‚ÑπÔ∏è Both requests succeeded - backend accepts concurrent requests', 'info');
                    log('‚úÖ Duplicate prevention should be handled by frontend loading states', 'success');
                    
                    // Cleanup both services
                    if (data1.service?.id) {
                        await fetch(`https://weddingbazaar-web.onrender.com/api/services/${data1.service.id}`, { method: 'DELETE' });
                    }
                    if (data2.service?.id) {
                        await fetch(`https://weddingbazaar-web.onrender.com/api/services/${data2.service.id}`, { method: 'DELETE' });
                    }
                    log('üóëÔ∏è Test services cleaned up', 'info');
                    
                    testResults.push({ test: 'Duplicate Prevention', status: 'FRONTEND_HANDLED' });
                } else {
                    log('‚ùå Duplicate submission test encountered errors', 'error');
                    testResults.push({ test: 'Duplicate Prevention', status: 'ERROR' });
                }

            } catch (error) {
                log(`‚ùå Duplicate submission test failed: ${error.message}`, 'error');
                testResults.push({ test: 'Duplicate Prevention', status: 'FAILED', error: error.message });
            }
        }

        async function runAllTests() {
            log('üéØ Running complete service creation test suite...', 'info');
            testResults = [];
            testCounter = 0;

            await testBackendEndpoint();
            await new Promise(resolve => setTimeout(resolve, 1000)); // Brief pause between tests
            
            await testServiceCreation();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await testDuplicateSubmission();

            // Summary
            log('üìã TEST SUITE SUMMARY:', 'info');
            log('=' . repeat(50), 'info');
            
            testResults.forEach((result, index) => {
                const status = result.status === 'PASSED' ? '‚úÖ PASSED' : 
                              result.status === 'FRONTEND_HANDLED' ? 'üîß FRONTEND_HANDLED' :
                              '‚ùå FAILED';
                log(`${index + 1}. ${result.test}: ${status}`, result.status === 'PASSED' || result.status === 'FRONTEND_HANDLED' ? 'success' : 'error');
                if (result.error) {
                    log(`   Error: ${result.error}`, 'error');
                }
                if (result.vendorIdStored !== undefined) {
                    log(`   Vendor ID Stored: ${result.vendorIdStored ? '‚úÖ YES' : '‚ùå NO'}`, result.vendorIdStored ? 'success' : 'error');
                }
            });

            const passedTests = testResults.filter(r => r.status === 'PASSED' || r.status === 'FRONTEND_HANDLED').length;
            log(`üéâ Test Results: ${passedTests}/${testResults.length} tests successful`, passedTests === testResults.length ? 'success' : 'error');
            
            if (passedTests === testResults.length) {
                log('üéä ALL TESTS PASSED! Service creation fix is working correctly.', 'success');
            } else {
                log('‚ö†Ô∏è Some tests failed. Please review the errors above.', 'error');
            }
        }

        // Auto-run tests on page load
        document.addEventListener('DOMContentLoaded', function() {
            log('üöÄ Service Creation Fix Verification Tool Loaded', 'info');
            log('üìù Testing backend vendor_id fix and frontend duplicate prevention', 'info');
            log('üîó Backend: https://weddingbazaar-web.onrender.com', 'info');
            log('üîó Frontend: https://weddingbazaarph.web.app', 'info');
        });
    </script>
</body>
</html>
