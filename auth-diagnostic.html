<!DOCTYPE html>
<html>
<head>
  <title>Auth Diagnostic</title>
  <style>
    body { 
      font-family: Arial, sans-serif; 
      max-width: 800px; 
      margin: 50px auto; 
      padding: 20px;
      background: #f5f5f5;
    }
    .card {
      background: white;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .success { color: #22c55e; }
    .error { color: #ef4444; }
    .warning { color: #f59e0b; }
    pre {
      background: #f8f9fa;
      padding: 10px;
      border-radius: 4px;
      overflow-x: auto;
    }
    button {
      background: #3b82f6;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      margin-right: 10px;
    }
    button:hover {
      background: #2563eb;
    }
  </style>
</head>
<body>
  <h1>üîç Authentication Diagnostic</h1>
  
  <div class="card">
    <h2>1. LocalStorage Data</h2>
    <div id="localStorage"></div>
  </div>

  <div class="card">
    <h2>2. User Object</h2>
    <div id="userObject"></div>
  </div>

  <div class="card">
    <h2>3. Test Backend Connection</h2>
    <button onclick="testBackend()">Test Backend</button>
    <div id="backendTest"></div>
  </div>

  <div class="card">
    <h2>4. Verify Vendor Exists</h2>
    <button onclick="checkVendor()">Check Vendor in DB</button>
    <div id="vendorCheck"></div>
  </div>

  <script>
    // Check localStorage
    const localStorageDiv = document.getElementById('localStorage');
    const authToken = localStorage.getItem('auth_token') || localStorage.getItem('authToken');
    const user = localStorage.getItem('user');
    
    let html = '<pre>';
    html += `auth_token: ${authToken ? '‚úÖ EXISTS' : '‚ùå MISSING'}\n`;
    html += `user: ${user ? '‚úÖ EXISTS' : '‚ùå MISSING'}\n`;
    html += '</pre>';
    
    if (!authToken) {
      html += '<p class="error">‚ö†Ô∏è No auth token found! You need to log in.</p>';
    }
    if (!user) {
      html += '<p class="error">‚ö†Ô∏è No user data found! You need to log in.</p>';
    }
    
    localStorageDiv.innerHTML = html;

    // Parse user object
    const userObjectDiv = document.getElementById('userObject');
    if (user) {
      try {
        const userData = JSON.parse(user);
        let userHtml = '<pre>' + JSON.stringify(userData, null, 2) + '</pre>';
        
        if (userData.role !== 'vendor') {
          userHtml += `<p class="warning">‚ö†Ô∏è You are logged in as: <strong>${userData.role}</strong> (not vendor)</p>`;
          userHtml += '<p>You need to log in as a vendor to create services.</p>';
        } else {
          userHtml += '<p class="success">‚úÖ You are logged in as a vendor</p>';
          userHtml += `<p>Vendor ID: <strong>${userData.id}</strong></p>`;
        }
        
        userObjectDiv.innerHTML = userHtml;
      } catch (e) {
        userObjectDiv.innerHTML = '<p class="error">‚ùå Error parsing user data: ' + e.message + '</p>';
      }
    } else {
      userObjectDiv.innerHTML = '<p class="error">‚ùå No user data available</p>';
    }

    // Test backend
    async function testBackend() {
      const div = document.getElementById('backendTest');
      div.innerHTML = '<p>Testing backend...</p>';
      
      try {
        const response = await fetch('https://weddingbazaar-web.onrender.com/api/health');
        const data = await response.json();
        
        if (response.ok) {
          div.innerHTML = '<p class="success">‚úÖ Backend is online and responding</p>';
        } else {
          div.innerHTML = '<p class="error">‚ùå Backend returned error: ' + response.status + '</p>';
        }
      } catch (error) {
        div.innerHTML = '<p class="error">‚ùå Cannot connect to backend: ' + error.message + '</p>';
      }
    }

    // Check if vendor exists in database
    async function checkVendor() {
      const div = document.getElementById('vendorCheck');
      
      if (!user) {
        div.innerHTML = '<p class="error">‚ùå No user data found. Please log in first.</p>';
        return;
      }
      
      try {
        const userData = JSON.parse(user);
        const vendorId = userData.id;
        
        div.innerHTML = `<p>Checking if vendor ID <strong>${vendorId}</strong> exists...</p>`;
        
        // Try to fetch vendor data
        const response = await fetch(`https://weddingbazaar-web.onrender.com/api/vendors/${vendorId}`);
        
        if (response.ok) {
          const vendorData = await response.json();
          div.innerHTML = '<p class="success">‚úÖ Vendor exists in database!</p>';
          div.innerHTML += '<pre>' + JSON.stringify(vendorData, null, 2) + '</pre>';
        } else if (response.status === 404) {
          div.innerHTML = '<p class="error">‚ùå Vendor NOT found in database</p>';
          div.innerHTML += `<p>Vendor ID <strong>${vendorId}</strong> does not exist in the vendors table.</p>`;
          div.innerHTML += '<p><strong>Solution:</strong> You need to create a vendor profile first!</p>';
        } else {
          div.innerHTML = `<p class="error">‚ùå Error checking vendor: ${response.status}</p>`;
        }
      } catch (error) {
        div.innerHTML = '<p class="error">‚ùå Error: ' + error.message + '</p>';
      }
    }
  </script>
</body>
</html>
