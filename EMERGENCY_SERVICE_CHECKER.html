<!DOCTYPE html>
<html>
<head>
  <title>ğŸ”¥ EMERGENCY SERVICE CHECKER</title>
  <style>
    body { font-family: Arial; padding: 40px; background: #1a1a1a; color: #fff; }
    .box { background: #2d2d2d; padding: 20px; margin: 20px 0; border-radius: 10px; border-left: 5px solid #00ff00; }
    .error { border-left-color: #ff0000; }
    .warning { border-left-color: #ffaa00; }
    button { background: #00ff00; color: #000; border: none; padding: 15px 30px; font-size: 18px; font-weight: bold; border-radius: 5px; cursor: pointer; margin: 10px 5px; }
    button:hover { background: #00cc00; }
    pre { background: #000; color: #00ff00; padding: 15px; border-radius: 5px; overflow-x: auto; }
    input { padding: 10px; font-size: 16px; width: 300px; border-radius: 5px; border: 2px solid #00ff00; }
  </style>
</head>
<body>
  <h1>ğŸ”¥ EMERGENCY SERVICE CHECKER</h1>
  <div class="box">
    <h2>Step 1: What's Your Vendor ID?</h2>
    <button onclick="checkSession()">ğŸ“¦ Check My Session</button>
    <div id="session-output"></div>
  </div>

  <div class="box">
    <h2>Step 2: Test API Directly</h2>
    <input type="text" id="vendor-id-input" placeholder="Enter vendor ID (e.g., 2-2025-003)">
    <button onclick="testAPI()">ğŸ§ª TEST API</button>
    <div id="api-output"></div>
  </div>

  <div class="box">
    <h2>Step 3: Apply Fix</h2>
    <button onclick="applyFix()">âœ… FIX NOW</button>
    <div id="fix-output"></div>
  </div>

  <script>
    const API = 'https://weddingbazaar-web.onrender.com';
    
    function checkSession() {
      const output = document.getElementById('session-output');
      const user = JSON.parse(localStorage.getItem('weddingbazaar_user') || 'null');
      
      if (!user) {
        output.innerHTML = '<div class="box error"><h3>âŒ NOT LOGGED IN!</h3><p>Please login first at: <a href="https://weddingbazaarph.web.app/login" style="color: #00ff00;">Login Page</a></p></div>';
        return;
      }
      
      output.innerHTML = `
        <pre>
USER SESSION DATA:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
User ID:     ${user.id || 'âŒ NOT SET'}
Vendor ID:   ${user.vendorId || 'âŒ NOT SET'}
Email:       ${user.email || 'N/A'}
Role:        ${user.role || 'N/A'}
Name:        ${user.name || user.businessName || 'N/A'}
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

${!user.vendorId ? 'âš ï¸ WARNING: vendorId is NOT SET!' : ''}
${user.vendorId && user.vendorId !== user.id ? 'âš ï¸ WARNING: vendorId MISMATCH!' : ''}
${user.vendorId === user.id ? 'âœ… Vendor ID looks correct!' : ''}
        </pre>
      `;
      
      // Auto-fill the input
      document.getElementById('vendor-id-input').value = user.vendorId || user.id || '';
    }
    
    async function testAPI() {
      const output = document.getElementById('api-output');
      const vendorId = document.getElementById('vendor-id-input').value;
      
      if (!vendorId) {
        output.innerHTML = '<div class="box error">âŒ Please enter a vendor ID or click "Check My Session" first!</div>';
        return;
      }
      
      output.innerHTML = '<div class="box">ğŸ”„ Testing API... Please wait...</div>';
      
      const endpoint = `${API}/api/services/vendor/${vendorId}`;
      
      try {
        console.log('Calling:', endpoint);
        const response = await fetch(endpoint);
        const data = await response.json();
        
        console.log('Response:', data);
        
        if (!response.ok) {
          output.innerHTML = `
            <div class="box error">
              <h3>âŒ API ERROR</h3>
              <p>Status: ${response.status}</p>
              <p>Error: ${data.error || data.message || 'Unknown error'}</p>
              <pre>${JSON.stringify(data, null, 2)}</pre>
            </div>
          `;
          return;
        }
        
        const serviceCount = data.services?.length || 0;
        
        if (serviceCount === 0) {
          output.innerHTML = `
            <div class="box warning">
              <h3>âš ï¸ NO SERVICES FOUND</h3>
              <p><strong>API returned 0 services for vendor ID: ${vendorId}</strong></p>
              <p>This means either:</p>
              <ul>
                <li>âœ… You haven't created any services yet (normal)</li>
                <li>âš ï¸ Services exist but with a different vendor_id</li>
                <li>âš ï¸ Vendor ID doesn't exist in database</li>
              </ul>
              <h4>ğŸ” Check Database:</h4>
              <p>Run this SQL in Neon Console:</p>
              <pre>
-- Check if services exist for this vendor
SELECT * FROM services WHERE vendor_id = '${vendorId}';

-- Check what vendor_ids DO exist
SELECT vendor_id, COUNT(*) as count 
FROM services 
GROUP BY vendor_id;

-- Check if vendor exists
SELECT * FROM vendors WHERE id = '${vendorId}';
              </pre>
            </div>
          `;
        } else {
          let serviceList = data.services.map((s, i) => `
            <div style="background: #1a1a1a; padding: 15px; margin: 10px 0; border-radius: 5px; border-left: 3px solid #00ff00;">
              <strong>${i + 1}. ${s.service_name || s.name}</strong><br>
              Category: ${s.service_category || s.category}<br>
              Price: â‚±${s.base_price || 'N/A'}<br>
              Active: ${s.is_active ? 'âœ… Yes' : 'âŒ No'}<br>
              Vendor ID: <code>${s.vendor_id}</code>
            </div>
          `).join('');
          
          output.innerHTML = `
            <div class="box" style="border-left-color: #00ff00;">
              <h3>ğŸ‰ SUCCESS! SERVICES FOUND!</h3>
              <p><strong>Found ${serviceCount} service(s) for vendor ID: ${vendorId}</strong></p>
              ${serviceList}
              <hr style="margin: 20px 0; border-color: #444;">
              <h4>âœ… DIAGNOSIS:</h4>
              <p><strong style="color: #00ff00;">Your services ARE in the database and the API is returning them!</strong></p>
              <p>If they're not showing on the vendor services page, the problem is:</p>
              <ul>
                <li>ğŸ”„ Browser cache (clear it!)</li>
                <li>ğŸ“¦ Old code loaded (hard refresh!)</li>
                <li>âš›ï¸ React state not updating</li>
                <li>ğŸ”§ vendorId not set in session (apply fix!)</li>
              </ul>
              <p><strong>Click "FIX NOW" button above to apply the session fix!</strong></p>
            </div>
          `;
        }
        
      } catch (error) {
        output.innerHTML = `
          <div class="box error">
            <h3>âŒ NETWORK ERROR</h3>
            <p>Could not connect to API: ${error.message}</p>
            <p>Backend URL: ${API}</p>
            <p>Check if backend is running!</p>
          </div>
        `;
      }
    }
    
    function applyFix() {
      const output = document.getElementById('fix-output');
      const user = JSON.parse(localStorage.getItem('weddingbazaar_user') || 'null');
      
      if (!user) {
        output.innerHTML = '<div class="box error">âŒ Not logged in! Please login first.</div>';
        return;
      }
      
      const oldVendorId = user.vendorId;
      user.vendorId = user.id;
      localStorage.setItem('weddingbazaar_user', JSON.stringify(user));
      
      output.innerHTML = `
        <div class="box" style="border-left-color: #00ff00;">
          <h3>âœ… FIX APPLIED!</h3>
          <pre>
BEFORE:
  User ID:    ${user.id}
  Vendor ID:  ${oldVendorId || 'âŒ NOT SET'}

AFTER:
  User ID:    ${user.id}
  Vendor ID:  ${user.vendorId}  âœ… FIXED!
          </pre>
          <p><strong>NOW:</strong></p>
          <ol>
            <li>Close ALL browser tabs</li>
            <li>Reopen browser</li>
            <li>Go to: <a href="https://weddingbazaarph.web.app/vendor/services" style="color: #00ff00;">Vendor Services</a></li>
            <li>Hard refresh: Ctrl+Shift+R</li>
          </ol>
          <button onclick="location.reload()">ğŸ”„ RELOAD THIS PAGE NOW</button>
        </div>
      `;
    }
    
    // Auto-run on load
    window.onload = () => {
      console.log('ğŸ”¥ Emergency Service Checker loaded');
      setTimeout(checkSession, 500);
    };
  </script>
</body>
</html>
